<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title id="dynamic-title">Gepersonaliseerde studieplanner</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">

  <style>
    :root {
      --bs-primary: #5294CF;
      --bs-success: #10B981;
      --bs-warning: #F97316;
      --bs-info: #4ADE80;
      --bs-light-bg: #F7F7F7;
    }
    body {
      background-color: var(--bs-light-bg);
      font-family: 'Inter', sans-serif;
      color: #1F2937;
    }
    .form-control:focus, .form-select:focus {
      border-color: var(--bs-primary);
      box-shadow: 0 0 0 0.25rem rgba(82, 148, 207, 0.4);
    }
    .step-active {
      background-color: var(--bs-primary) !important;
      color: white !important;
      border-color: var(--bs-primary) !important;
    }
    .btn-check:checked + .btn-custom-style {
      background-color: var(--bs-primary);
      border-color: var(--bs-primary);
      color: white;
    }
    .small-muted { font-size: .9rem; color: #6B7280; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm border-bottom">
    <div class="container-fluid container-lg">
      <span class="navbar-brand h1 mb-0 fs-4 fw-bold">
        <span class="text-primary">Studeer</span>AI
      </span>
      <div class="d-flex align-items-center">
        <a href="over_ons.html" class="nav-link text-dark me-3 d-none d-sm-block">Doel van gepersonaliseerde studieplanner</a>
        <a href="voor_docenten.html" class="nav-link text-dark me-3 d-none d-sm-block">Voor docenten</a>
        <button class="btn btn-primary fw-semibold rounded-3 shadow-sm py-2" type="button">
          <svg xmlns="http://www.w3.org/2000/svg" class="me-2" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z" />
          </svg>
          Mijn plannen
        </button>
      </div>
    </div>
  </nav>

  <main class="container py-5">
    <header class="text-center mb-5">
      <h1 id="main-header-title" class="display-5 fw-extrabold mb-2">Jouw gepersonaliseerde studieplan</h1>
      <p id="main-header-subtitle" class="lead text-secondary">
        Laat de AI je toetsstof structureren; de planning wordt daarna 100% in JavaScript opgebouwd.
      </p>
    </header>

    <!-- Steps indicator -->
    <div class="row justify-content-center mb-5">
      <div class="col-12 col-md-10 col-lg-8">
        <div class="d-flex justify-content-between align-items-center text-center">
          <div class="d-flex flex-column align-items-center flex-fill position-relative">
            <div class="step-active rounded-circle border border-2 border-primary d-flex align-items-center justify-content-center fw-bold mb-1" style="width: 40px; height: 40px;">1</div>
            <p class="text-sm fw-semibold text-primary text-center mt-1">Jouw profiel</p>
          </div>

          <div class="flex-fill bg-secondary-subtle mx-2" style="height: 2px;"></div>

          <div class="d-flex flex-column align-items-center flex-fill position-relative">
            <div id="step-marker-2" class="rounded-circle border border-2 border-secondary text-secondary d-flex align-items-center justify-content-center fw-bold mb-1" style="width: 40px; height: 40px;">2</div>
            <p class="text-sm fw-semibold text-secondary text-center mt-1">Jouw leerstof</p>
          </div>

          <div class="flex-fill bg-secondary-subtle mx-2" style="height: 2px;"></div>

          <div class="d-flex flex-column align-items-center flex-fill position-relative">
            <div id="step-marker-3" class="rounded-circle border border-2 border-secondary text-secondary d-flex align-items-center justify-content-center fw-bold mb-1" style="width: 40px; height: 40px;">3</div>
            <p class="text-sm fw-semibold text-secondary text-center mt-1">Jouw startsituatie</p>
          </div>

          <div class="flex-fill bg-secondary-subtle mx-2" style="height: 2px;"></div>

          <div class="d-flex flex-column align-items-center flex-fill position-relative">
            <div id="step-marker-4" class="rounded-circle border border-2 border-secondary text-secondary d-flex align-items-center justify-content-center fw-bold mb-1" style="width: 40px; height: 40px;">4</div>
            <p class="text-sm fw-semibold text-secondary text-center mt-1">Jouw planning</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Main card -->
    <div id="planner-card" class="card p-4 p-md-5 rounded-4 shadow-lg border-0">
      <div class="card-body">

        <!-- Step 1 -->
        <section id="step-1-setup" class="mb-5">
          <h2 class="h4 fw-bold mb-3 border-bottom border-primary-subtle pb-2">1. Jouw profiel & invoer</h2>

          <div class="row g-3 mb-4">
            <div class="col-md-6">
              <label for="first-name" class="form-label text-dark fw-medium">Voornaam:</label>
              <input type="text" id="first-name" autocomplete="given-name" placeholder="Je voornaam" oninput="updateTitle()" class="form-control form-control-lg bg-light border-secondary-subtle rounded-3">
            </div>
            <div class="col-md-6">
              <label for="last-name" class="form-label text-dark fw-medium">Achternaam:</label>
              <input type="text" id="last-name" autocomplete="family-name" placeholder="Je achternaam" oninput="updateTitle()" class="form-control form-control-lg bg-light border-secondary-subtle rounded-3">
            </div>
          </div>

          <div class="row g-3 mb-4">
            <div class="col-md-6">
              <label for="niveau-select" class="form-label text-dark fw-medium">Leerjaar:</label>
              <select id="niveau-select" class="form-select form-select-lg bg-light border-secondary-subtle rounded-3" onchange="updateProgress()">
                <option value="">Kies leerjaar...</option>
                <option value="1">Leerjaar 1</option>
                <option value="2">Leerjaar 2</option>
                <option value="3">Leerjaar 3</option>
                <option value="4">Leerjaar 4</option>
                <option value="5">Leerjaar 5</option>
                <option value="6">Leerjaar 6</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="stroom-select" class="form-label text-dark fw-medium">Onderwijsstroom:</label>
              <select id="stroom-select" class="form-select form-select-lg bg-light border-secondary-subtle rounded-3" onchange="updateProgress()">
                <option value="">Kies stroom...</option>
                <option value="vmbo">VMBO</option>
                <option value="havo">HAVO</option>
                <option value="vwo">VWO</option>
              </select>
            </div>
          </div>

          <div class="row g-3 mb-4">
            <div class="col-12 col-md-6">
              <label for="end-date-input" class="form-label text-dark fw-medium">
                Selecteer de einddatum (planning loopt van vandaag tot deze datum):
              </label>
              <input type="date" id="end-date-input" onchange="updateProgress()" class="form-control form-control-lg bg-light border-secondary-subtle rounded-3">
              <div class="form-text">Tip: zet dit gelijk aan de laatste toets of werkdeadline.</div>
            </div>
          </div>

          <!-- Input Methode: Tekst + Bestand upload -->
          <div class="mb-4 p-4 bg-light rounded-3 border border-secondary-subtle">
            <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
              <button type="button" class="btn btn-outline-secondary rounded-3" onclick="setApiKeyViaPrompt()">
                OpenRouter sleutel instellen (lokaal)
              </button>
              <button type="button" class="btn btn-outline-danger rounded-3" onclick="clearApiKey()">
                Sleutel wissen
              </button>
              <span class="small text-muted">
                Sleutel blijft client-side. Gebruik dit enkel voor demo/test.
              </span>
            </div>

            <label for="text-input" class="form-label text-dark fw-medium">Plak hier je huiswerk of toetsstof:</label>
            <textarea id="text-input" rows="5" autocomplete="off" class="form-control bg-white border-secondary-subtle rounded-3"
              placeholder="Bijv: Wiskunde B: toets h6 op 4 dec (par 6.1-6.5). Engels: woordenschat unit 5&6 op 5 dec. CKV verslag deadline 8 dec."></textarea>

            <div class="row g-3 mt-2">
              <div class="col-12 col-lg-6">
                <label for="file-input" class="form-label text-dark fw-medium mt-1">Of upload een bestand (PDF / Excel / CSV / TXT):</label>
                <input type="file" id="file-input" class="form-control bg-white border-secondary-subtle rounded-3" accept=".pdf,.xlsx,.xls,.csv,.txt">
              </div>
              <div class="col-12 col-lg-6">
                <label for="json-input" class="form-label text-dark fw-medium mt-1">Of upload JSON met taken (real data, geen mock):</label>
                <input type="file" id="json-input" class="form-control bg-white border-secondary-subtle rounded-3" accept=".json,application/json">
                <div class="form-text">JSON verwacht: array met Vaknaam/Toetsnaam/Toetsdatum of Deadline/Stof_Omschrijving/Geschatte_Tijd_Min.</div>
              </div>
            </div>

            <div class="form-text mt-2">
              We analyseren: (1) JSON upload, of (2) bestand/tekst via OpenRouter.
            </div>

            <button id="ai-process-btn" onclick="handleTextUpload()" class="btn btn-primary mt-3 w-100 d-flex align-items-center justify-content-center" type="button">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-stars me-2" viewBox="0 0 16 16">
                <path d="M7.657 6.247c.11-.33.576-.33.686 0l.645 1.937a2.89 2.89 0 0 0 1.829 1.828l1.936.645c.33.11.33.576 0 .686l-1.937.645a2.89 2.89 0 0 0-1.828 1.829l-.645 1.936a.361.361 0 0 1-.686 0l-.645-1.937a2.89 2.89 0 0 0-1.828-1.828l-1.937-.645a.361.361 0 0 1 0-.686l1.937-.645a2.89 2.89 0 0 0 1.828-1.828l.645-1.937z" />
              </svg>
              Haal toetsstof op (JSON of OpenRouter)
            </button>

            <div class="mt-3 small-muted">
              Debug: sleutel aanwezig? <span class="mono" id="key-present">nee</span>
            </div>
          </div>

          <!-- Status -->
          <div id="setup-status" class="mt-4 p-3 bg-primary-subtle text-primary rounded-3 border border-primary-subtle d-none">
            <p class="small fw-medium mb-0" id="status-message">Status...</p>
          </div>
        </section>

        <!-- Step 2 -->
        <section id="step-2-subjects" class="mb-5 d-none">
          <h2 class="h4 fw-bold mb-3 border-bottom border-primary-subtle pb-2">2. Je leerstof & toetsoverzicht</h2>

          <div class="mb-4">
            <p class="small text-secondary mb-3">Vakken gevonden. Vink aan wat je wil inplannen.</p>
            <div id="subject-checkboxes" class="row g-3 p-3 bg-light rounded-3 border border-secondary-subtle"></div>
          </div>

          <h3 class="h5 fw-semibold mb-3">Toetsoverzicht (met datum/deadline + tijd)</h3>
          <div id="tests-table-wrapper" class="p-3 bg-white border border-secondary-subtle rounded-3 shadow-sm">
            <div class="small text-secondary">Selecteer minstens één vak om de toetsen te zien.</div>
          </div>
        </section>

        <!-- Step 3 (NEW) -->
        <section id="step-3-intake" class="mb-5 d-none">
          <h2 class="h4 fw-bold mb-3 border-bottom border-primary-subtle pb-2">3. Jouw korte check & keuzes</h2>

          <div class="row g-4">
            <div class="col-12">
              <label for="feedback-clarity" class="form-label text-dark fw-medium">
                Is alles duidelijk in je planning? Zo niet: wat is niet duidelijk?
              </label>
              <textarea id="feedback-clarity" rows="3"
                class="form-control form-control-lg bg-light border-secondary-subtle rounded-3"
                placeholder="Bijv. Ik snap niet goed hoe ik vak X moet aanpakken..."></textarea>
            </div>

            <div class="col-12">
              <label for="hardest-and-priority" class="form-label text-dark fw-medium">
                Wat lijkt jou het lastigst? En welke vakken krijgen prioriteit?
              </label>
              <textarea id="hardest-and-priority" rows="3"
                class="form-control form-control-lg bg-light border-secondary-subtle rounded-3"
                placeholder="Bijv. Geschiedenis is veel stof; prioriteit: wiskunde + geschiedenis..."></textarea>
            </div>

            <div class="col-12 col-lg-7">
              <label for="time-availability" class="form-label text-dark fw-medium">
                Extra info (optioneel): hoeveel tijd heb je en op welke dagen?
              </label>
              <textarea id="time-availability" rows="3"
                class="form-control form-control-lg bg-light border-secondary-subtle rounded-3"
                placeholder="Bijv. ma/di/do 60min, weekend 120min, wo geen tijd..."></textarea>
              <div class="form-text">De planning hieronder gebruikt de gestructureerde instellingen rechts.</div>
            </div>

            <div class="col-12 col-lg-5">
              <div class="p-3 bg-light rounded-3 border border-secondary-subtle">
                <div class="fw-semibold mb-2">Beschikbaarheid (gebruikt voor planning)</div>

                <label class="form-label small text-dark fw-medium mb-1" for="minutes-per-day">Gemiddeld minuten per studiedag</label>
                <input id="minutes-per-day" type="number" min="15" step="5"
                  class="form-control bg-white border-secondary-subtle rounded-3 mb-3" value="90">

                <div class="small text-dark fw-medium mb-1">Welke dagen kan je studeren?</div>
                <div class="d-flex flex-wrap gap-2 mb-1">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="dow-1" checked>
                    <label class="form-check-label" for="dow-1">Ma</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="dow-2" checked>
                    <label class="form-check-label" for="dow-2">Di</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="dow-3" checked>
                    <label class="form-check-label" for="dow-3">Wo</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="dow-4" checked>
                    <label class="form-check-label" for="dow-4">Do</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="dow-5" checked>
                    <label class="form-check-label" for="dow-5">Vr</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="dow-6">
                    <label class="form-check-label" for="dow-6">Za</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="dow-0">
                    <label class="form-check-label" for="dow-0">Zo</label>
                  </div>
                </div>
                <div class="form-text">Tip: zet weekend aan als je echt wil inhalen.</div>
              </div>
            </div>

            <div class="col-12">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <label class="form-label text-dark fw-medium mb-0">
                  Per vak: wat ga je precies doen?
                </label>
                <small class="text-muted">Wordt automatisch gevuld op basis van je selectie.</small>
              </div>

              <div id="subject-reflection-container" class="p-3 bg-light rounded-3 border border-secondary-subtle">
                <p class="small text-secondary mb-0">Selecteer vakken in stap 2 om dit onderdeel te vullen.</p>
              </div>
            </div>

            <div class="col-12">
              <label class="form-label text-dark fw-medium mb-2">
                Wil je extra tips per vak (via AI), of alleen het plan?
              </label>

              <div class="btn-group w-100" role="group" aria-label="Tips voorkeur">
                <input type="radio" class="btn-check" name="tips-choice" id="tips-keep" autocomplete="off" checked>
                <label class="btn btn-outline-secondary rounded-3 btn-lg btn-custom-style" for="tips-keep">
                  Alleen planning
                </label>

                <input type="radio" class="btn-check" name="tips-choice" id="tips-extra" autocomplete="off">
                <label class="btn btn-outline-secondary rounded-3 btn-lg btn-custom-style" for="tips-extra">
                  Extra tips per vak (AI)
                </label>
              </div>

              <p class="text-muted small mt-2 mb-0">
                AI wordt dan alleen gebruikt voor korte tips/herformulering (planning blijft JS).
              </p>
            </div>
          </div>
        </section>

        <!-- Generate button -->
        <div id="generate-section" class="mt-4 text-center d-none">
          <button onclick="generatePlan()" class="btn btn-primary btn-lg fw-bold rounded-4 shadow py-3 px-5 w-100 w-md-auto" type="button">
            <svg class="me-3" width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
            </svg>
            Genereer Mijn Persoonlijke Plan
          </button>
        </div>

        <!-- Step 4 -->
        <section id="step-4-result" class="mt-5 d-none">
          <h2 class="h4 fw-bold mb-3 border-bottom border-success-subtle pb-2 d-flex align-items-center text-success">
            <svg class="me-2" width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            4. Jouw planning (dagen + datums + toetsen)
          </h2>

          <div id="warnings" class="alert alert-warning d-none" role="alert"></div>

          <div id="tips-box" class="alert alert-light border border-primary-subtle p-4 mb-4 d-none" role="alert">
            <h3 class="h5 fw-semibold text-primary mb-2">Extra tips (AI)</h3>
            <div id="tips-content" class="text-secondary small mb-0"></div>
          </div>

          <div class="table-responsive rounded-3 shadow">
            <table class="table table-striped table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th scope="col" class="px-3 py-3 text-start small text-muted text-uppercase fw-semibold">Datum</th>
                  <th scope="col" class="px-3 py-3 text-start small text-muted text-uppercase fw-semibold">Dag</th>
                  <th scope="col" class="px-3 py-3 text-start small text-muted text-uppercase fw-semibold">Taken (vak + toets)</th>
                  <th scope="col" class="px-3 py-3 text-center small text-muted text-uppercase fw-semibold">Tijd (min)</th>
                  <th scope="col" class="px-3 py-3 text-center small text-muted text-uppercase fw-semibold">Af</th>
                </tr>
              </thead>
              <tbody id="plan-body"></tbody>
            </table>
          </div>
        </section>

      </div>
    </div>
  </main>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <!-- Libs for PDF/Excel parsing -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    // =========================
    // State
    // =========================
    // Array of items:
    // { id, Vaknaam, Toetsnaam, Toetsdatum, Deadline, dueDate, Stof_Omschrijving, Geschatte_Tijd_Min_Docent, Geschatte_Tijd_Min_Leerling, Aanbevolen_Methode }
    let tasks = [];
    let selectedSubjectsCount = 0;

    // =========================
    // Utilities
    // =========================
    function isoToday() {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function parseISOToDate(iso) {
      // iso: YYYY-MM-DD
      const [y, m, d] = String(iso).split("-").map(Number);
      return new Date(y, (m || 1) - 1, d || 1);
    }

    function formatNLDate(iso) {
      try {
        const dt = parseISOToDate(iso);
        return dt.toLocaleDateString("nl-NL", { year: "numeric", month: "2-digit", day: "2-digit" });
      } catch {
        return iso;
      }
    }

    function weekdayShortNL(dateObj) {
      const map = ["Zo", "Ma", "Di", "Wo", "Do", "Vr", "Za"];
      return map[dateObj.getDay()] || "";
    }

    function sanitizeIdPart(s) {
      return String(s || "")
        .toLowerCase()
        .replace(/\s+/g, "-")
        .replace(/[^a-z0-9\-_]/g, "");
    }

    function unique(arr) {
      return Array.from(new Set(arr));
    }

    // =========================
    // Toast / status
    // =========================
    function alertUser(message, variant = "danger") {
      let container = document.getElementById("toast-container");
      if (!container) {
        container = document.createElement("div");
        container.id = "toast-container";
        container.className = "toast-container position-fixed top-0 end-0 p-3";
        container.style.zIndex = "1080";
        document.body.appendChild(container);
      }

      const toastEl = document.createElement("div");
      toastEl.className = `toast align-items-center text-bg-${variant} border-0`;
      toastEl.setAttribute("role", "alert");
      toastEl.setAttribute("aria-live", "assertive");
      toastEl.setAttribute("aria-atomic", "true");

      toastEl.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${String(message)}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      `;

      container.appendChild(toastEl);
      const toast = new bootstrap.Toast(toastEl, { delay: 3200 });
      toast.show();
      toastEl.addEventListener("hidden.bs.toast", () => toastEl.remove());
    }

    function setStatus(type, message) {
      const setupStatus = document.getElementById('setup-status');
      const statusMessage = document.getElementById('status-message');
      if (!setupStatus || !statusMessage) return;

      setupStatus.classList.remove('d-none');
      setupStatus.classList.remove(
        "bg-primary-subtle","text-primary","border-primary-subtle",
        "bg-danger-subtle","text-danger","border-danger-subtle",
        "bg-success-subtle","text-success","border-success-subtle"
      );

      if (type === "success") setupStatus.classList.add("bg-success-subtle","text-success","border-success-subtle");
      else if (type === "danger") setupStatus.classList.add("bg-danger-subtle","text-danger","border-danger-subtle");
      else setupStatus.classList.add("bg-primary-subtle","text-primary","border-primary-subtle");

      statusMessage.textContent = message;
    }

    // =========================
    // API key helpers (OpenRouter)
    // =========================
    function getApiKeyFromLocalStorage() {
      return (localStorage.getItem("OPENROUTER_API_KEY") || "").trim();
    }
    function refreshKeyIndicator() {
      const el = document.getElementById("key-present");
      if (!el) return;
      el.textContent = getApiKeyFromLocalStorage() ? "ja" : "nee";
    }
    function setApiKeyViaPrompt() {
      const v = prompt("Plak je OpenRouter API key (begint met sk-or-v1...):", getApiKeyFromLocalStorage());
      if (v && v.trim()) {
        localStorage.setItem("OPENROUTER_API_KEY", v.trim());
        alertUser("Sleutel opgeslagen (lokaal).", "success");
      } else {
        alertUser("Geen sleutel ingesteld.");
      }
      refreshKeyIndicator();
    }
    function clearApiKey() {
      localStorage.removeItem("OPENROUTER_API_KEY");
      alertUser("Sleutel gewist.", "warning");
      refreshKeyIndicator();
    }

    // =========================
    // File/text reading
    // =========================
    async function readInputAsText() {
      const textArea = document.getElementById("text-input");
      const fileInput = document.getElementById("file-input");
      const file = fileInput?.files?.[0];

      if (!file) return (textArea?.value || "").trim();

      const ext = (file.name.split(".").pop() || "").toLowerCase();

      if (ext === "txt" || ext === "csv") return (await file.text()).trim();

      if (ext === "xlsx" || ext === "xls") {
        const buf = await file.arrayBuffer();
        const wb = XLSX.read(buf, { type: "array" });
        const sheetName = wb.SheetNames[0];
        const ws = wb.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(ws, { header: 1, raw: false });
        return rows.map(r => r.filter(Boolean).join(" | ")).join("\n").trim();
      }

      if (ext === "pdf") {
        const buf = await file.arrayBuffer();

        if (window.pdfjsLib?.GlobalWorkerOptions) {
          window.pdfjsLib.GlobalWorkerOptions.workerSrc =
            "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.worker.min.js";
        }

        const pdf = await window.pdfjsLib.getDocument({ data: buf }).promise;
        let text = "";
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          const pageText = content.items.map(it => it.str).join(" ");
          text += pageText + "\n";
        }
        return text.trim();
      }

      throw new Error("Onbekend bestandstype. Gebruik PDF, Excel, CSV of TXT.");
    }

    async function tryLoadJsonTasks() {
      const input = document.getElementById("json-input");
      const file = input?.files?.[0];
      if (!file) return null;

      const raw = await file.text();
      const data = JSON.parse(raw);

      // Accept both { items: [...] } or [...]
      const arr = Array.isArray(data) ? data : (data?.items || null);
      if (!Array.isArray(arr)) throw new Error("JSON is geen array (of geen object met 'items').");

      return normalizeTasks(arr);
    }

    function safeParseJsonArray(s) {
      // Direct parse
      try {
        const v = JSON.parse(s);
        if (Array.isArray(v)) return v;
      } catch (e) {}

      // Extract [...]
      const start = s.indexOf("[");
      const end = s.lastIndexOf("]");
      if (start !== -1 && end !== -1 && end > start) {
        const slice = s.slice(start, end + 1);
        const v2 = JSON.parse(slice);
        if (Array.isArray(v2)) return v2;
      }
      throw new Error("AI output is geen geldige JSON array.");
    }

    function normalizeTasks(arr) {
      const normalized = [];
      for (let i = 0; i < arr.length; i++) {
        const it = arr[i] || {};
        const Vaknaam = String(it.Vaknaam || "").trim();
        const Toetsnaam = String(it.Toetsnaam || "").trim();
        const Toetsdatum = it.Toetsdatum ? String(it.Toetsdatum).trim() : null;
        const Deadline = it.Deadline ? String(it.Deadline).trim() : null;
        const Stof_Omschrijving = String(it.Stof_Omschrijving || "").trim();
        const minRaw = ("Geschatte_Tijd_Min" in it) ? Number(it.Geschatte_Tijd_Min) : Number(it.Geschatte_Tijd_Min_Leerling || it.Geschatte_Tijd_Min_Docent || 0);

        const dueDate = Toetsdatum || Deadline;
        if (!Vaknaam || !Toetsnaam || !dueDate || !/^\d{4}-\d{2}-\d{2}$/.test(dueDate)) continue;

        const minutes = Number.isFinite(minRaw) && minRaw > 0 ? Math.round(minRaw) : 60;

        normalized.push({
          id: `t_${i}_${sanitizeIdPart(Vaknaam)}_${sanitizeIdPart(Toetsnaam)}`,
          Vaknaam,
          Toetsnaam,
          Toetsdatum: Toetsdatum || null,
          Deadline: Deadline || null,
          dueDate,
          Stof_Omschrijving,
          Aanbevolen_Methode: it.Aanbevolen_Methode ? String(it.Aanbevolen_Methode) : null,
          Geschatte_Tijd_Min_Docent: Number.isFinite(Number(it.Geschatte_Tijd_Min_Docent)) ? Math.round(Number(it.Geschatte_Tijd_Min_Docent)) : minutes,
          Geschatte_Tijd_Min_Leerling: Number.isFinite(Number(it.Geschatte_Tijd_Min_Leerling)) ? Math.round(Number(it.Geschatte_Tijd_Min_Leerling)) : minutes
        });
      }

      if (!normalized.length) throw new Error("Geen geldige taken gevonden in JSON. Vereist: Vaknaam, Toetsnaam, Toetsdatum of Deadline (YYYY-MM-DD), Stof_Omschrijving, Geschatte_Tijd_Min.");
      return normalized;
    }

    // =========================
    // Step 2 rendering
    // =========================
    function getSubjectsFromTasks(taskList) {
      return unique((taskList || []).map(t => t.Vaknaam)).sort((a,b) => a.localeCompare(b, "nl"));
    }

    function getSelectedSubjects() {
      const checkboxes = document.querySelectorAll('#subject-checkboxes input[type="checkbox"]');
      const subjects = getSubjectsFromTasks(tasks);
      return subjects.filter((s, idx) => checkboxes[idx] && checkboxes[idx].checked);
    }

    function updateSelectedSubjectsCount() {
      selectedSubjectsCount = document.querySelectorAll('#subject-checkboxes input:checked').length;
      renderTestsTable();
      renderSubjectReflectionFields();
      updateProgress();
    }

    function loadSubjects() {
      const checkboxContainer = document.getElementById('subject-checkboxes');
      if (!checkboxContainer) return;

      const subjects = getSubjectsFromTasks(tasks);
      const colorMap = ["primary","danger","success","warning","info","secondary"];
      checkboxContainer.innerHTML = subjects.map((name, index) => {
        const c = colorMap[index % colorMap.length];
        const id = `check-${c}-${index}`;
        return `
          <div class="col-6 col-sm-4 col-md-3">
            <div class="p-2 bg-white rounded-3 border border-secondary-subtle shadow-sm">
              <div class="form-check">
                <input class="form-check-input border-secondary-subtle fs-5" type="checkbox" checked onchange="updateSelectedSubjectsCount()" id="${id}" style="margin-top: 0.3em;">
                <label class="form-check-label fw-medium text-dark" for="${id}">
                  ${name}
                </label>
              </div>
            </div>
          </div>
        `;
      }).join('');

      updateSelectedSubjectsCount();
    }

    function renderTestsTable() {
      const wrapper = document.getElementById("tests-table-wrapper");
      if (!wrapper) return;

      const selected = getSelectedSubjects();
      if (!selected.length) {
        wrapper.innerHTML = `<div class="small text-secondary">Selecteer minstens één vak om de toetsen te zien.</div>`;
        return;
      }

      const rows = tasks
        .filter(t => selected.includes(t.Vaknaam))
        .slice()
        .sort((a,b) => String(a.dueDate).localeCompare(String(b.dueDate)));

      if (!rows.length) {
        wrapper.innerHTML = `<div class="small text-secondary">Geen toetsen gevonden voor de selectie.</div>`;
        return;
      }

      wrapper.innerHTML = `
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead>
              <tr>
                <th>Vak</th>
                <th>Toets / opdracht</th>
                <th>Datum</th>
                <th class="text-center">Docent (min)</th>
                <th class="text-center">Leerling (min)</th>
              </tr>
            </thead>
            <tbody>
              ${rows.map((t) => {
                const label = t.Toetsdatum ? "Toets" : "Deadline";
                const date = t.dueDate;
                return `
                  <tr>
                    <td class="fw-semibold">${t.Vaknaam}</td>
                    <td>
                      <div class="fw-semibold">${t.Toetsnaam}</div>
                      <div class="small text-secondary">${escapeHtml(t.Stof_Omschrijving || "")}</div>
                    </td>
                    <td>
                      <span class="badge bg-light text-dark border">${label}</span>
                      <span class="ms-2">${formatNLDate(date)}</span>
                      <div class="small text-secondary mono">${date}</div>
                    </td>
                    <td class="text-center">
                      <input type="number" class="form-control form-control-sm text-center" value="${t.Geschatte_Tijd_Min_Docent}" disabled>
                    </td>
                    <td class="text-center" style="max-width: 110px;">
                      <input type="number" class="form-control form-control-sm text-center"
                        min="15" step="5" value="${t.Geschatte_Tijd_Min_Leerling}"
                        oninput="updateTaskMinutes('${t.id}', this.value)">
                    </td>
                  </tr>
                `;
              }).join("")}
            </tbody>
          </table>
        </div>
        <div class="small text-secondary mt-2">
          De planning gebruikt <b>Leerling (min)</b>. Docent (min) is indicatief.
        </div>
      `;
    }

    function updateTaskMinutes(taskId, newValue) {
      const v = Number(newValue);
      const idx = tasks.findIndex(t => t.id === taskId);
      if (idx === -1) return;
      tasks[idx].Geschatte_Tijd_Min_Leerling = (Number.isFinite(v) && v > 0) ? Math.round(v) : tasks[idx].Geschatte_Tijd_Min_Leerling;
    }

    function escapeHtml(s) {
      return String(s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // =========================
    // Step 3 per-subject fields
    // =========================
    function renderSubjectReflectionFields() {
      const container = document.getElementById("subject-reflection-container");
      if (!container) return;

      const selected = getSelectedSubjects();
      if (!selected.length) {
        container.innerHTML = `<p class="small text-secondary mb-0">Selecteer vakken in stap 2 om dit onderdeel te vullen.</p>`;
        return;
      }

      container.innerHTML = selected.map((subject) => {
        const sid = sanitizeIdPart(subject);
        const relevant = tasks.filter(t => t.Vaknaam === subject)
          .sort((a,b)=> String(a.dueDate).localeCompare(String(b.dueDate)));

        const autoMust = relevant.map(t => `${t.Toetsnaam} (${t.dueDate}): ${t.Stof_Omschrijving || ""}`).join("\n");

        return `
          <div class="bg-white rounded-3 border border-secondary-subtle p-3 mb-3 shadow-sm">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="fw-semibold text-dark">${subject}</div>
              <span class="badge bg-primary-subtle text-primary border border-primary-subtle rounded-pill">Vak</span>
            </div>

            <div class="mb-2">
              <label class="form-label small text-dark fw-medium" for="subj-must-${sid}">
                Wat moet je doen (verplicht / toetsstof)?
              </label>
              <textarea id="subj-must-${sid}" rows="3"
                class="form-control bg-light border-secondary-subtle rounded-3"
                placeholder="Bijv. hoofdstuk samenvatten + begrippen leren + oefenvragen...">${escapeHtml(autoMust)}</textarea>
              <div class="form-text">Automatisch ingevuld op basis van je toetsen. Pas gerust aan.</div>
            </div>

            <div class="mb-2">
              <label class="form-label small text-dark fw-medium" for="subj-plan-${sid}">
                Wat denk je echt te gaan doen (realistisch)?
              </label>
              <textarea id="subj-plan-${sid}" rows="2"
                class="form-control bg-light border-secondary-subtle rounded-3"
                placeholder="Bijv. 2x oefenen + 1 samenvatting + flashcards..."></textarea>
            </div>

            <div class="mb-0">
              <label class="form-label small text-dark fw-medium" for="subj-how-${sid}">
                Hoe ga je werken (aanpak)?
              </label>
              <textarea id="subj-how-${sid}" rows="2"
                class="form-control bg-light border-secondary-subtle rounded-3"
                placeholder="Bijv. 25 min blokken, telefoon weg, eerst moeilijke onderdelen..."></textarea>
            </div>
          </div>
        `;
      }).join("");
    }

    function collectIntakeData() {
      const feedbackClarity = document.getElementById("feedback-clarity")?.value.trim() || "";
      const hardestAndPriority = document.getElementById("hardest-and-priority")?.value.trim() || "";
      const timeAvailabilityText = document.getElementById("time-availability")?.value.trim() || "";

      const tipsChoice = document.getElementById("tips-extra")?.checked ? "extra" : "keep";
      const minutesPerDay = Number(document.getElementById("minutes-per-day")?.value || 90);

      const allowedDows = [];
      // JS: 0=Sun..6=Sat
      for (const d of [0,1,2,3,4,5,6]) {
        if (document.getElementById(`dow-${d}`)?.checked) allowedDows.push(d);
      }

      const selected = getSelectedSubjects();
      const subjectDetails = selected.map((subj) => {
        const sid = sanitizeIdPart(subj);
        return {
          subject: subj,
          must_do: document.getElementById(`subj-must-${sid}`)?.value.trim() || "",
          likely_do: document.getElementById(`subj-plan-${sid}`)?.value.trim() || "",
          how_work: document.getElementById(`subj-how-${sid}`)?.value.trim() || ""
        };
      });

      return {
        feedback_clarity: feedbackClarity,
        hardest_and_priority: hardestAndPriority,
        time_availability_text: timeAvailabilityText,
        tips_choice: tipsChoice,
        minutes_per_day: (Number.isFinite(minutesPerDay) && minutesPerDay > 0) ? Math.round(minutesPerDay) : 90,
        allowed_dows: allowedDows.length ? allowedDows : [1,2,3,4,5],
        subject_details: subjectDetails
      };
    }

    // =========================
    // OpenRouter extraction (real)
    // =========================
    async function handleTextUpload() {
      const processBtn = document.getElementById('ai-process-btn');

      // 1) JSON upload has priority
      try {
        const jsonTasks = await tryLoadJsonTasks();
        if (jsonTasks) {
          tasks = jsonTasks;
          setStatus("success", `JSON geladen: ${tasks.length} toets(en)/deadline(s) gevonden.`);
          loadSubjects();
          updateProgress();
          document.getElementById('step-2-subjects')?.scrollIntoView({ behavior: "smooth" });
          return;
        }
      } catch (e) {
        setStatus("danger", `JSON fout: ${e.message}`);
        alertUser(`JSON fout: ${e.message}`);
        return;
      }

      // 2) Otherwise use OpenRouter
      let textInput = "";
      try {
        textInput = await readInputAsText();
      } catch (e) {
        setStatus("danger", e.message);
        alertUser(e.message);
        return;
      }

      if (!textInput) {
        alertUser("Voer eerst tekst in of upload een bestand (of JSON).");
        return;
      }

      const leerlingLeerjaar = document.getElementById("niveau-select")?.value;
      const leerlingStroom = document.getElementById("stroom-select")?.value;
      const endISO = document.getElementById("end-date-input")?.value;
      const startISO = isoToday();

      if (!leerlingLeerjaar || !leerlingStroom) {
        alertUser("Selecteer eerst leerjaar en onderwijsstroom.");
        return;
      }
      if (!endISO) {
        alertUser("Selecteer een einddatum (tot wanneer je planning loopt).");
        return;
      }

      let apiKey = getApiKeyFromLocalStorage();
      if (!apiKey) {
        setApiKeyViaPrompt();
        apiKey = getApiKeyFromLocalStorage();
      }
      if (!apiKey) {
        alertUser("Geen OpenRouter API key ingesteld (of upload JSON).");
        return;
      }

      // loading state
      const originalBtnText = processBtn?.innerHTML || "";
      if (processBtn) {
        processBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Bezig...';
        processBtn.disabled = true;
      }
      const restoreButton = () => {
        if (!processBtn) return;
        processBtn.innerHTML = originalBtnText;
        processBtn.disabled = false;
      };

      try {
        setStatus("primary", "AI: toetsstof extraheren...");

        const prompt = `
You are a study-task extraction engine.

Student profile:
- grade_year: ${leerlingLeerjaar}
- school_track: ${leerlingStroom}

Allowed planning window:
- start_date: ${startISO}
- end_date: ${endISO}

Goal:
Extract ALL tests and deadlines from the text. Do not hallucinate.

Return ONLY a valid JSON array of objects (no Markdown, no backticks).

Each object must have EXACTLY these keys:
- "Vaknaam" (string)
- "Toetsnaam" (string)
- "Toetsdatum" (YYYY-MM-DD or null)
- "Deadline" (YYYY-MM-DD or null)
- "Stof_Omschrijving" (string)
- "Geschatte_Tijd_Min" (integer, realistic total study minutes for this test/deadline)
- "Aanbevolen_Methode" (one of: "Samenvatten","Oefensommen","Flashcards","Mindmap","Lezen","Oefentoets")

Rules:
- Either Toetsdatum OR Deadline must be provided (one can be null).
- If no date is present in the input, set both to null and EXCLUDE the object (we need dates to plan).
- If a date is outside the planning window, EXCLUDE the object.
- Do NOT invent dates or subjects.
- If a task is clearly for a different grade or track, exclude it.
- Keep "Stof_Omschrijving" short but complete.

Text to analyze:
"${textInput.replaceAll('"','\\"')}"
        `.trim();

        const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${apiKey}`,
            "HTTP-Referer": window.location.href,
            "X-Title": "StudeerPlanner AI",
          },
          body: JSON.stringify({
            model: "google/gemini-2.0-flash-lite-001",
            messages: [{ role: "user", content: prompt }],
            temperature: 0.2
          }),
        });

        if (!response.ok) {
          let errorMsg = response.statusText;
          try {
            const errorData = await response.json();
            if (errorData?.error?.message) errorMsg = errorData.error.message;
          } catch (e) {}
          throw new Error(`OpenRouter error (${response.status}): ${errorMsg}`);
        }

        const result = await response.json();
        let aiText = result?.choices?.[0]?.message?.content ?? "";
        aiText = aiText.replace(/```json/g, "").replace(/```/g, "").trim();

        const parsed = safeParseJsonArray(aiText);

        // Filter & normalize
        const filtered = parsed.filter((it) => {
          const d = it?.Toetsdatum || it?.Deadline;
          if (!d) return false;
          if (!/^\d{4}-\d{2}-\d{2}$/.test(String(d))) return false;
          return String(d) >= startISO && String(d) <= endISO;
        });

        tasks = normalizeTasks(filtered.map((it) => ({
          Vaknaam: it.Vaknaam,
          Toetsnaam: it.Toetsnaam,
          Toetsdatum: it.Toetsdatum,
          Deadline: it.Deadline,
          Stof_Omschrijving: it.Stof_Omschrijving,
          Geschatte_Tijd_Min: it.Geschatte_Tijd_Min,
          Aanbevolen_Methode: it.Aanbevolen_Methode
        })));

        setStatus("success", `AI klaar: ${tasks.length} toets(en)/deadline(s) gevonden.`);
        loadSubjects();
        updateProgress();
        document.getElementById('step-2-subjects')?.scrollIntoView({ behavior: "smooth" });

      } catch (error) {
        console.error(error);
        setStatus("danger", `Fout: ${error.message}`);
        alertUser(`Fout: ${error.message}`);
      } finally {
        restoreButton();
      }
    }

    // =========================
    // Progress/state UI
    // =========================
    function markStepActive(markerEl, ok, success=false) {
      if (!markerEl) return;
      markerEl.classList.remove("step-active");
      markerEl.classList.add("border-secondary", "text-secondary");
      markerEl.style.borderColor = "";
      markerEl.style.backgroundColor = "";
      if (ok) {
        markerEl.classList.add("step-active");
        markerEl.classList.remove("border-secondary", "text-secondary");
        if (success) {
          markerEl.style.borderColor = "var(--bs-success)";
          markerEl.style.backgroundColor = "var(--bs-success)";
        }
      }
    }

    function updateProgress() {
      const step2 = document.getElementById("step-2-subjects");
      const step3 = document.getElementById("step-3-intake");
      const gen = document.getElementById("generate-section");
      const step4 = document.getElementById("step-4-result");

      const m2 = document.getElementById("step-marker-2");
      const m3 = document.getElementById("step-marker-3");
      const m4 = document.getElementById("step-marker-4");

      const leerlingLeerjaar = document.getElementById("niveau-select")?.value;
      const leerlingStroom = document.getElementById("stroom-select")?.value;
      const endISO = document.getElementById("end-date-input")?.value;

      const isProfileSelected = !!leerlingLeerjaar && !!leerlingStroom && !!endISO;

      const hasTasks = Array.isArray(tasks) && tasks.length > 0;
      const isStep2Ready = isProfileSelected && hasTasks;

      if (isStep2Ready) {
        step2?.classList.remove("d-none");
        markStepActive(m2, true);
      } else {
        step2?.classList.add("d-none");
        markStepActive(m2, false);
      }

      const isStep3Ready = isStep2Ready && selectedSubjectsCount > 0;
      if (isStep3Ready) {
        step3?.classList.remove("d-none");
        gen?.classList.remove("d-none");
        markStepActive(m3, true);
      } else {
        step3?.classList.add("d-none");
        gen?.classList.add("d-none");
        step4?.classList.add("d-none");
        markStepActive(m3, false);
        markStepActive(m4, false);
      }
    }

    // =========================
    // Title
    // =========================
    function updateTitle() {
      const firstName = document.getElementById('first-name')?.value.trim() || "";
      const lastName = document.getElementById('last-name')?.value.trim() || "";
      const today = new Date().toLocaleDateString('nl-NL');

      const mainHeader = document.getElementById('main-header-title');
      const mainSubtitle = document.getElementById('main-header-subtitle');

      let titleText = "StudeerPlanner AI";
      if (firstName || lastName) titleText = `Studieplanning van ${firstName} ${lastName} (${today})`;
      document.title = titleText;

      if (firstName || lastName) {
        if (mainHeader) mainHeader.textContent = `Gepersonaliseerde studieplan van ${firstName} ${lastName}`;
        if (mainSubtitle) {
          mainSubtitle.textContent = `Gegenereerd op: ${today}`;
          mainSubtitle.classList.add('text-dark', 'fw-bold');
          mainSubtitle.classList.remove('text-secondary', 'lead');
        }
      } else {
        if (mainHeader) mainHeader.textContent = "Jouw gepersonaliseerde studieplan";
        if (mainSubtitle) {
          mainSubtitle.textContent = "Laat de AI je toetsstof structureren; de planning wordt daarna 100% in JavaScript opgebouwd.";
          mainSubtitle.classList.add('text-secondary', 'lead');
          mainSubtitle.classList.remove('text-dark', 'fw-bold');
        }
      }
    }

    // =========================
    // Planning (100% JS)
    // =========================
    function buildDateRange(startISO, endISO) {
      const start = parseISOToDate(startISO);
      const end = parseISOToDate(endISO);
      const days = [];
      const cur = new Date(start.getFullYear(), start.getMonth(), start.getDate());

      while (cur <= end) {
        const yyyy = cur.getFullYear();
        const mm = String(cur.getMonth() + 1).padStart(2, "0");
        const dd = String(cur.getDate()).padStart(2, "0");
        const iso = `${yyyy}-${mm}-${dd}`;
        days.push({ iso, dateObj: new Date(cur.getTime()), dow: cur.getDay() });
        cur.setDate(cur.getDate() + 1);
      }
      return days;
    }

    function getSelectedTaskItems() {
      const selectedSubjects = getSelectedSubjects();
      const items = tasks
        .filter(t => selectedSubjects.includes(t.Vaknaam))
        .map(t => ({
          ...t,
          remaining: Math.max(0, Number(t.Geschatte_Tijd_Min_Leerling) || 0)
        }))
        .sort((a,b)=> String(a.dueDate).localeCompare(String(b.dueDate)));

      return items;
    }

    function allocateMinutesToSchedule(items, startISO, endISO, minutesPerDay, allowedDows) {
      const days = buildDateRange(startISO, endISO);

      const allowed = new Set(allowedDows);
      const capacityByDay = {};
      for (const d of days) {
        capacityByDay[d.iso] = allowed.has(d.dow) ? minutesPerDay : 0;
      }

      const allocations = {}; // dateISO -> [ { vak, toets, minutes, dueDate } ]
      const warnings = [];

      // Earliest due first
      for (const item of items) {
        const due = item.dueDate;
        const dueInRange = (due >= startISO && due <= endISO);
        if (!dueInRange) continue;

        // allocate on days from start to due (inclusive)
        // (If you want "not on test day", change to due-1 here.)
        const eligibleDays = days.filter(d => d.iso >= startISO && d.iso <= due && capacityByDay[d.iso] > 0);

        let remaining = item.remaining;

        for (const day of eligibleDays) {
          if (remaining <= 0) break;
          const cap = capacityByDay[day.iso] || 0;
          if (cap <= 0) continue;

          const take = Math.min(cap, remaining);
          capacityByDay[day.iso] = cap - take;
          remaining -= take;

          if (!allocations[day.iso]) allocations[day.iso] = [];
          allocations[day.iso].push({
            Vaknaam: item.Vaknaam,
            Toetsnaam: item.Toetsnaam,
            dueDate: item.dueDate,
            Stof_Omschrijving: item.Stof_Omschrijving,
            minutes: take,
            Aanbevolen_Methode: item.Aanbevolen_Methode || null
          });
        }

        if (remaining > 0) {
          warnings.push(`Onvoldoende tijd ingepland voor ${item.Vaknaam} – ${item.Toetsnaam} (nog ${remaining} min over, deadline/toets: ${item.dueDate}).`);
        }
      }

      return { days, allocations, warnings };
    }

    async function maybeGenerateTips(intake) {
      if (intake.tips_choice !== "extra") return null;

      const apiKey = getApiKeyFromLocalStorage();
      if (!apiKey) {
        alertUser("Geen OpenRouter sleutel: extra tips overslaan.", "warning");
        return null;
      }

      const selected = intake.subject_details || [];
      if (!selected.length) return null;

      const prompt = `
Je bent een docent-assistent. Geef per vak 2-4 ultrakorte, concrete studietips (max 1 zin per tip), in leerlingentaal.
Geen leertijlen, geen theorie.

Context (leerling):
- feedback_clarity: ${intake.feedback_clarity}
- hardest_and_priority: ${intake.hardest_and_priority}
- availability: ${intake.time_availability_text}

Vakken (met leerlingnotities):
${selected.map(s => `- ${s.subject}
  must_do: ${s.must_do}
  likely_do: ${s.likely_do}
  how_work: ${s.how_work}`).join("\n")}

Output: return ONLY valid JSON object:
{
  "tips": [
    { "vak": "....", "items": ["tip 1", "tip 2"] }
  ]
}
      `.trim();

      const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${apiKey}`,
          "HTTP-Referer": window.location.href,
          "X-Title": "StudeerPlanner AI",
        },
        body: JSON.stringify({
          model: "google/gemini-2.0-flash-lite-001",
          messages: [{ role: "user", content: prompt }],
          temperature: 0.3
        })
      });

      if (!res.ok) {
        let msg = res.statusText;
        try {
          const j = await res.json();
          if (j?.error?.message) msg = j.error.message;
        } catch(e) {}
        throw new Error(`Tips API error (${res.status}): ${msg}`);
      }

      const out = await res.json();
      let txt = out?.choices?.[0]?.message?.content ?? "";
      txt = txt.replace(/```json/g, "").replace(/```/g, "").trim();

      const obj = JSON.parse(txt);
      if (!obj || !Array.isArray(obj.tips)) throw new Error("Tips: ongeldige JSON output.");
      return obj;
    }

    async function generatePlan() {
      const leerlingLeerjaar = document.getElementById("niveau-select")?.value;
      const leerlingStroom = document.getElementById("stroom-select")?.value;
      const endISO = document.getElementById("end-date-input")?.value;
      const startISO = isoToday();

      if (!leerlingLeerjaar || !leerlingStroom || !endISO) {
        alertUser("Vul leerjaar, stroom en einddatum in (stap 1).");
        return;
      }
      if (!Array.isArray(tasks) || tasks.length === 0) {
        alertUser("Geen toetsstof. Upload JSON of gebruik OpenRouter analyse (stap 1).");
        return;
      }
      if (selectedSubjectsCount === 0) {
        alertUser("Selecteer minstens één vak (stap 2).");
        return;
      }

      const intake = collectIntakeData();
      const minutesPerDay = intake.minutes_per_day;
      const allowedDows = intake.allowed_dows;

      const items = getSelectedTaskItems();
      if (!items.length) {
        alertUser("Geen taken gevonden voor jouw vakselectie.");
        return;
      }

      const generateButton = document.querySelector('#generate-section button');
      const step4 = document.getElementById("step-4-result");
      const marker4 = document.getElementById("step-marker-4");

      if (generateButton) {
        generateButton.disabled = true;
        generateButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Planning maken...';
      }

      try {
        // JS planning
        const { days, allocations, warnings } = allocateMinutesToSchedule(items, startISO, endISO, minutesPerDay, allowedDows);

        // render warnings
        const warnEl = document.getElementById("warnings");
        if (warnings.length) {
          warnEl.classList.remove("d-none");
          warnEl.innerHTML = `<div class="fw-semibold mb-1">Let op:</div><ul class="mb-0">${warnings.map(w=>`<li>${escapeHtml(w)}</li>`).join("")}</ul>`;
        } else {
          warnEl.classList.add("d-none");
          warnEl.textContent = "";
        }

        // render plan table
        const body = document.getElementById("plan-body");
        body.innerHTML = "";

        const plannedDates = days.filter(d => allocations[d.iso] && allocations[d.iso].length);
        if (!plannedDates.length) {
          alertUser("Er kon geen planning gemaakt worden (controleer dagen/minuten).", "warning");
          return;
        }

        for (const d of plannedDates) {
          const list = allocations[d.iso];
          const total = list.reduce((s,x)=> s + (x.minutes||0), 0);

          const itemsHtml = list.map(x => {
            const methodBadge = x.Aanbevolen_Methode ? `<span class="badge bg-info-subtle text-info border border-info-subtle rounded-pill ms-2">${escapeHtml(x.Aanbevolen_Methode)}</span>` : "";
            const due = x.dueDate ? `<span class="badge bg-light text-dark border ms-2">due ${escapeHtml(x.dueDate)}</span>` : "";
            return `
              <div class="mb-2">
                <div class="fw-semibold">${escapeHtml(x.Vaknaam)} — ${escapeHtml(x.Toetsnaam)} ${due}</div>
                <div class="small text-secondary">${escapeHtml(x.Stof_Omschrijving || "")}</div>
                <div class="small text-secondary">Blok: <b>${x.minutes} min</b>${methodBadge}</div>
              </div>
            `;
          }).join("");

          const row = document.createElement("tr");
          row.innerHTML = `
            <td class="px-3 py-3 fw-semibold">${formatNLDate(d.iso)}<div class="small text-secondary mono">${d.iso}</div></td>
            <td class="px-3 py-3">${weekdayShortNL(d.dateObj)}</td>
            <td class="px-3 py-3">${itemsHtml}</td>
            <td class="px-3 py-3 text-center fw-semibold">${total}</td>
            <td class="px-3 py-3 text-center"><input type="checkbox" class="form-check-input" style="width:20px;height:20px;"></td>
          `;
          body.appendChild(row);
        }

        // Optional AI tips
        const tipsBox = document.getElementById("tips-box");
        const tipsContent = document.getElementById("tips-content");
        tipsBox.classList.add("d-none");
        tipsContent.innerHTML = "";

        if (intake.tips_choice === "extra") {
          setStatus("primary", "AI tips ophalen...");
          try {
            const tipsObj = await maybeGenerateTips(intake);
            if (tipsObj?.tips?.length) {
              tipsBox.classList.remove("d-none");
              tipsContent.innerHTML = tipsObj.tips.map(t => `
                <div class="mb-3">
                  <div class="fw-semibold">${escapeHtml(t.vak)}</div>
                  <ul class="mb-0">
                    ${(t.items || []).map(it => `<li>${escapeHtml(it)}</li>`).join("")}
                  </ul>
                </div>
              `).join("");
            }
          } catch (e) {
            alertUser(`Tips mislukt: ${e.message}`, "warning");
          }
        }

        // show step 4
        step4.classList.remove("d-none");
        markStepActive(marker4, true, true);
        step4.scrollIntoView({ behavior: "smooth" });
        setStatus("success", "Planning gemaakt.");

      } finally {
        if (generateButton) {
          generateButton.disabled = false;
          generateButton.innerHTML = `
            <svg class="me-3" width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
            </svg>
            Genereer Mijn Persoonlijke Plan
          `;
        }
      }
    }

    // =========================
    // DOMContentLoaded
    // =========================
    document.addEventListener('DOMContentLoaded', () => {
      refreshKeyIndicator();

      const endDateInput = document.getElementById('end-date-input');
      if (endDateInput && !endDateInput.value) endDateInput.value = isoToday();

      document.getElementById("minutes-per-day")?.addEventListener("input", () => {});
      for (const d of [0,1,2,3,4,5,6]) {
        document.getElementById(`dow-${d}`)?.addEventListener("change", () => {});
      }

      document.getElementById("json-input")?.addEventListener("change", async () => {
        try {
          const jsonTasks = await tryLoadJsonTasks();
          if (jsonTasks) {
            tasks = jsonTasks;
            setStatus("success", `JSON geladen: ${tasks.length} toets(en)/deadline(s).`);
            loadSubjects();
            updateProgress();
            document.getElementById('step-2-subjects')?.scrollIntoView({ behavior: "smooth" });
          }
        } catch (e) {
          setStatus("danger", `JSON fout: ${e.message}`);
          alertUser(`JSON fout: ${e.message}`);
        }
      });

      updateTitle();
      updateProgress();
    });

    // Expose for inline handlers
    Object.assign(window, {
      setApiKeyViaPrompt,
      clearApiKey,
      handleTextUpload,
      updateTitle,
      updateProgress,
      updateSelectedSubjectsCount,
      generatePlan,
      updateTaskMinutes
    });
  </script>
</body>
</html>
