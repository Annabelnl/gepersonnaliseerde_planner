<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title id="dynamic-title">Gepersonaliseerde studieplanner</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">

  <style>
    :root {
      --bs-primary: #5294CF;
      --bs-success: #10B981;
      --bs-warning: #F97316;
      --bs-info: #4ADE80;
      --bs-light-bg: #F7F7F7;
    }
    body {
      background-color: var(--bs-light-bg);
      font-family: 'Inter', sans-serif;
      color: #1F2937;
    }
    .form-control:focus, .form-select:focus {
      border-color: var(--bs-primary);
      box-shadow: 0 0 0 0.25rem rgba(82, 148, 207, 0.4);
    }
    .step-active {
      background-color: var(--bs-primary) !important;
      color: white !important;
      border-color: var(--bs-primary) !important;
    }
    .btn-check:checked + .btn-custom-style {
      background-color: var(--bs-primary);
      border-color: var(--bs-primary);
      color: white;
    }
  </style>
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm border-bottom">
    <div class="container-fluid container-lg">
      <span class="navbar-brand h1 mb-0 fs-4 fw-bold">
        <span class="text-primary">Studeer</span>AI
      </span>
      <div class="d-flex align-items-center">
        <a href="over_ons.html" class="nav-link text-dark me-3 d-none d-sm-block">Doel van gepersonaliseerde studieplanner</a>
        <a href="voor_docenten.html" class="nav-link text-dark me-3 d-none d-sm-block">Voor docenten</a>
        <button class="btn btn-primary fw-semibold rounded-3 shadow-sm py-2" type="button">
          <svg xmlns="http://www.w3.org/2000/svg" class="me-2" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z" />
          </svg>
          Mijn plannen
        </button>
      </div>
    </div>
  </nav>

  <main class="container py-5">
    <header class="text-center mb-5">
      <h1 id="main-header-title" class="display-5 fw-extrabold mb-2">Jouw gepersonaliseerde studieplan</h1>
      <p id="main-header-subtitle" class="lead text-secondary">
        Laat de AI jouw studielast verdelen in haalbare, motiverende stappen.
      </p>
    </header>

    <!-- Steps indicator -->
    <div class="row justify-content-center mb-5">
      <div class="col-12 col-md-10 col-lg-8">
        <div class="d-flex justify-content-between align-items-center text-center">
          <div class="d-flex flex-column align-items-center flex-fill position-relative">
            <div class="step-active rounded-circle border border-2 border-primary d-flex align-items-center justify-content-center fw-bold mb-1" style="width: 40px; height: 40px;">1</div>
            <p class="text-sm fw-semibold text-primary text-center mt-1">Jouw profiel</p>
          </div>

          <div class="flex-fill bg-secondary-subtle mx-2" style="height: 2px;"></div>

          <div class="d-flex flex-column align-items-center flex-fill position-relative">
            <div class="rounded-circle border border-2 border-secondary text-secondary d-flex align-items-center justify-content-center fw-bold mb-1" style="width: 40px; height: 40px;">2</div>
            <p class="text-sm fw-semibold text-secondary text-center mt-1">Jouw leerstof</p>
          </div>

          <div class="flex-fill bg-secondary-subtle mx-2" style="height: 2px;"></div>

          <div class="d-flex flex-column align-items-center flex-fill position-relative">
            <div class="rounded-circle border border-2 border-secondary text-secondary d-flex align-items-center justify-content-center fw-bold mb-1" style="width: 40px; height: 40px;">3</div>
            <p class="text-sm fw-semibold text-secondary text-center mt-1">Jouw startsituatie</p>
          </div>

          <div class="flex-fill bg-secondary-subtle mx-2" style="height: 2px;"></div>

          <div class="d-flex flex-column align-items-center flex-fill position-relative">
            <div class="rounded-circle border border-2 border-secondary text-secondary d-flex align-items-center justify-content-center fw-bold mb-1" style="width: 40px; height: 40px;">4</div>
            <p class="text-sm fw-semibold text-secondary text-center mt-1">Jouw planning</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Main card -->
    <div id="planner-card" class="card p-4 p-md-5 rounded-4 shadow-lg border-0">
      <div class="card-body">

        <!-- Step 1 -->
        <section id="step-1-setup" class="mb-5">
          <h2 class="h4 fw-bold mb-3 border-bottom border-primary-subtle pb-2">1. Jouw profiel & invoer</h2>

          <div class="row g-3 mb-4">
            <div class="col-md-6">
              <label for="first-name" class="form-label text-dark fw-medium">Voornaam:</label>
              <input type="text" id="first-name" autocomplete="given-name" placeholder="Je voornaam" oninput="updateTitle()" class="form-control form-control-lg bg-light border-secondary-subtle rounded-3">
            </div>
            <div class="col-md-6">
              <label for="last-name" class="form-label text-dark fw-medium">Achternaam:</label>
              <input type="text" id="last-name" autocomplete="family-name" placeholder="Je achternaam" oninput="updateTitle()" class="form-control form-control-lg bg-light border-secondary-subtle rounded-3">
            </div>
          </div>

          <div class="row g-3 mb-4">
            <div class="col-md-6">
              <label for="niveau-select" class="form-label text-dark fw-medium">Leerjaar:</label>
              <select id="niveau-select" class="form-select form-select-lg bg-light border-secondary-subtle rounded-3" onchange=""updateProgress()>
                <option value="">Kies leerjaar...</option>
                <option value="1">Leerjaar 1</option>
                <option value="2">Leerjaar 2</option>
                <option value="3">Leerjaar 3</option>
                <option value="4">Leerjaar 4</option>
                <option value="5">Leerjaar 5</option>
                <option value="6">Leerjaar 6</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="stroom-select" class="form-label text-dark fw-medium">Onderwijsstroom:</label>
              <select id="stroom-select" class="form-select form-select-lg bg-light border-secondary-subtle rounded-3" onchange=""updateProgress()>
                <option value="">Kies stroom...</option>
                <option value="vmbo">VMBO</option>
                <option value="havo">HAVO</option>
                <option value="vwo">VWO</option>
              </select>
            </div>
          </div>

          <div class="row g-3 mb-4">
            <div class="col-12 col-md-6">
              <label for="start-date-input" class="form-label text-dark fw-medium">
                Selecteer de einddatum (planning loopt van vandaag tot deze datum):
              </label>
              <input type="date" id="start-date-input" onchange="updateProgress()" class="form-control form-control-lg bg-light border-secondary-subtle rounded-3">
            </div>
          </div>

          <!-- Input Methode: Tekst + Bestand upload -->
          <div class="mb-4 p-4 bg-light rounded-3 border border-secondary-subtle">
            <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
              <button type="button" class="btn btn-outline-secondary rounded-3" onclick="setApiKeyViaPrompt()">
                AI sleutel instellen (lokaal)
              </button>
              <button type="button" class="btn btn-outline-danger rounded-3" onclick="clearApiKey()">
                AI sleutel wissen
              </button>
              <span class="small text-muted">
                (GitHub Pages: sleutel blijft client-side, alleen voor demo.)
              </span>
            </div>

            <label for="text-input" class="form-label text-dark fw-medium">Plak hier je huiswerk of toetsstof:</label>
            <textarea id="text-input" rows="5" autocomplete="off" class="form-control bg-white border-secondary-subtle rounded-3"
              placeholder="Bijv: Ik heb volgende week een toets wiskunde over hoofdstuk 3 en 4. Voor Engels moet ik de woordjes van unit 1 leren en een opstel schrijven."></textarea>

            <label for="file-input" class="form-label text-dark fw-medium mt-3">Of upload een bestand (PDF / Excel / CSV / TXT):</label>
            <input type="file" id="file-input" class="form-control bg-white border-secondary-subtle rounded-3" accept=".pdf,.xlsx,.xls,.csv,.txt">
            <div class="form-text">We analyseren ofwel de geplakte tekst, ofwel het bestand (als je er één kiest).</div>

            <button id="ai-process-btn" onclick="handleTextUpload()" class="btn btn-primary mt-3 w-100 d-flex align-items-center justify-content-center" type="button">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-stars me-2" viewBox="0 0 16 16">
                <path d="M7.657 6.247c.11-.33.576-.33.686 0l.645 1.937a2.89 2.89 0 0 0 1.829 1.828l1.936.645c.33.11.33.576 0 .686l-1.937.645a2.89 2.89 0 0 0-1.828 1.829l-.645 1.936a.361.361 0 0 1-.686 0l-.645-1.937a2.89 2.89 0 0 0-1.828-1.828l-1.937-.645a.361.361 0 0 1 0-.686l1.937-.645a2.89 2.89 0 0 0 1.828-1.828l.645-1.937zM3.794 1.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387A1.734 1.734 0 0 0 4.593 5.69l-.387 1.162a.217.217 0 0 1-.412 0L3.407 5.69A1.734 1.734 0 0 0 2.31 4.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387A1.734 1.734 0 0 0 3.407 2.31l.387-1.162zM10.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732L9.1 2.137a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L10.863.1z" />
              </svg>
              Analyseer met AI (OpenRouter)
            </button>
          </div>

          <!-- Status -->
          <div id="setup-status" class="mt-4 p-3 bg-primary-subtle text-primary rounded-3 border border-primary-subtle d-none">
            <p class="small fw-medium mb-0" id="status-message">Status...</p>
          </div>
        </section>

        <!-- Step 2 -->
        <section id="step-2-subjects" class="mb-5 d-none">
          <h2 class="h4 fw-bold mb-3 border-bottom border-primary-subtle pb-2">2. Je leerstof & toetsoverzicht</h2>

          <div class="mb-4">
            <p class="small text-secondary mb-3">Hieronder staan de vakken die we uit je invoer hebben gehaald. Vink aan wat je wilt inplannen.</p>
            <div id="subject-checkboxes" class="row g-3 p-3 bg-light rounded-3 border border-secondary-subtle"></div>
          </div>

          <h3 class="h5 fw-semibold mb-3">Visueel toetsoverzicht (kleurcode)</h3>
          <div id="test-overview" class="p-4 bg-white border border-secondary-subtle rounded-3 shadow-sm">
            <p class="small text-secondary mb-0">Selecteer minimaal één vak om het overzicht te zien.</p>
          </div>
        </section>

        <!-- Step 3 -->
        <section id="step-3-intake" class="mb-5 d-none">
          <h2 class="h4 fw-bold mb-3 border-bottom border-primary-subtle pb-2">3. Jouw voorkeuren (intake)</h2>

          <div class="row g-4">
            <div class="col-12">
              <label class="form-label text-dark fw-medium mb-2">Wat is jouw dominante leerstijl?</label>
              <div class="btn-group w-100" role="group" aria-label="Leerstijl">
                <input type="radio" class="btn-check" name="learning-style" id="style-visueel" autocomplete="off">
                <label class="btn btn-outline-secondary rounded-3 btn-lg btn-custom-style" for="style-visueel" onclick="selectStyle('style-visueel')">Visueel (Zien)</label>

                <input type="radio" class="btn-check" name="learning-style" id="style-auditief" autocomplete="off">
                <label class="btn btn-outline-secondary rounded-3 btn-lg btn-custom-style" for="style-auditief" onclick="selectStyle('style-auditief')">Auditief (Horen)</label>

                <input type="radio" class="btn-check" name="learning-style" id="style-kinesthetisch" autocomplete="off">
                <label class="btn btn-outline-secondary rounded-3 btn-lg btn-custom-style" for="style-kinesthetisch" onclick="selectStyle('style-kinesthetisch')">Kinesthetisch (Doen)</label>
              </div>
              <p class="text-muted small mt-2">De AI zal methoden aanbevelen die hierbij passen.</p>
            </div>

            <div class="col-md-6">
              <label for="time-per-day" class="form-label text-dark fw-medium">Hoeveel tijd (gemiddeld) heb je dagelijks beschikbaar om te studeren (in uren)?</label>
              <input type="number" id="time-per-day" placeholder="Bijv. 2" class="form-control form-control-lg bg-light border-secondary-subtle rounded-3">
            </div>

            <div class="col-md-6">
              <label for="biggest-fear" class="form-label text-dark fw-medium">Wat vind je het moeilijkst of waar ben je bang voor deze toetsweek?</label>
              <textarea id="biggest-fear" rows="2" placeholder="Bijv. Dat ik de grote hoeveelheid stof voor Geschiedenis niet op tijd leer." class="form-control form-control-lg bg-light border-secondary-subtle rounded-3"></textarea>
            </div>

            <div class="col-12">
              <label class="form-label text-dark fw-medium mb-2">Hoe werk je het liefst?</label>
              <div class="btn-group w-100" role="group" aria-label="Werkvoorkeur">
                <input type="radio" class="btn-check" name="work-preference" id="work-short" autocomplete="off">
                <label class="btn btn-outline-secondary rounded-3 btn-lg btn-custom-style" for="work-short" onclick="selectStyle('work-short')">Korte Blokken (25 min / 5 min pauze)</label>

                <input type="radio" class="btn-check" name="work-preference" id="work-long" autocomplete="off">
                <label class="btn btn-outline-secondary rounded-3 btn-lg btn-custom-style" for="work-long" onclick="selectStyle('work-long')">Langere Focus (45-60 min)</label>
              </div>
              <p class="text-muted small mt-2">De AI gebruikt dit om Pomodoro- of diepe focusblokken in te plannen.</p>
            </div>
          </div>
        </section>

        <!-- Generate button -->
        <div id="generate-section" class="mt-4 text-center d-none">
          <button onclick="generatePlan()" class="btn btn-primary btn-lg fw-bold rounded-4 shadow py-3 px-5 w-100 w-md-auto" type="button">
            <svg class="me-3" width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
            </svg>
            Genereer Mijn Persoonlijke Plan
          </button>
        </div>

        <!-- Step 4 -->
        <section id="step-4-result" class="mt-5 d-none">
          <h2 class="h4 fw-bold mb-3 border-bottom border-success-subtle pb-2 d-flex align-items-center text-success">
            <svg class="me-2" width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            4. Jouw planning is klaar!
          </h2>

          <div class="alert alert-light border border-primary-subtle p-4 mb-4" role="alert">
            <h3 class="h5 fw-semibold text-primary mb-2">Persoonlijke tip van de AI</h3>
            <p class="text-secondary mb-0 fst-italic">
              "Omdat je aangaf bang te zijn voor Geschiedenis, beginnen we elke dag met een korte, haalbare stap van 20 minuten."
            </p>
          </div>

          <div class="table-responsive rounded-3 shadow">
            <table class="table table-striped table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th scope="col" class="px-3 py-3 text-start small text-muted text-uppercase fw-semibold">Dag</th>
                  <th scope="col" class="px-3 py-3 text-start small text-muted text-uppercase fw-semibold">Taak & Vak</th>
                  <th scope="col" class="px-3 py-3 text-start small text-muted text-uppercase fw-semibold">Strategie</th>
                  <th scope="col" class="px-3 py-3 text-center small text-muted text-uppercase fw-semibold">Tijd (min)</th>
                  <th scope="col" class="px-3 py-3 text-center small text-muted text-uppercase fw-semibold">Afgerond</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="px-3 py-3 fw-bold fs-5 text-primary">Ma</td>
                  <td class="px-3 py-3">
                    <span class="d-block fw-semibold">Hoofdstuk 3 (Stap 1/5)</span>
                    <span class="d-block small text-secondary">Vak: Geschiedenis</span>
                  </td>
                  <td class="px-3 py-3">
                    <span class="badge bg-info text-info-emphasis border border-info-subtle rounded-pill fw-medium">Mindmap</span>
                  </td>
                  <td class="px-3 py-3 text-center">20</td>
                  <td class="px-3 py-3 text-center">
                    <input type="checkbox" class="form-check-input border-secondary-subtle" style="width: 20px; height: 20px;">
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

<!-- Libs for PDF/Excel parsing -->
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<!-- App JS -->
<script>
  // Fallback (if AI fails / demo)
  const SUBJECT_DATA_FALLBACK = [
    { name: "Nederlands", color: "bg-primary", shortColor: "primary", tests: [{ name: "Analyse Lezen", type: "Inzicht", time: 30 }] },
    { name: "Engels", color: "bg-danger", shortColor: "danger", tests: [{ name: "Woordenschat Unit 5", type: "Kennis", time: 30 }] },
    { name: "Wiskunde B", color: "bg-success", shortColor: "success", tests: [{ name: "Hoofdstuk 7 Oefenen", type: "Toepassing", time: 45 }] },
    { name: "Geschiedenis", color: "bg-warning", shortColor: "warning", tests: [{ name: "Middeleeuwen Samenvatting", type: "Kennis", time: 30 }] },
    { name: "Biologie", color: "bg-info", shortColor: "info", tests: [{ name: "DNA Structuur", type: "Inzicht", time: 30 }] },
    { name: "Economie", color: "bg-secondary", shortColor: "secondary", tests: [{ name: "Marktwerking Casus", type: "Toepassing", time: 30 }] },
  ];

  let importedSubjectData = null;
  let selectedSubjectsCount = 0;

  const stepMarkersContainer = document.querySelector('.row.justify-content-center.mb-5 .d-flex.justify-content-between');
  let stepMarkers = [];
  if (stepMarkersContainer) {
    stepMarkers = [
      stepMarkersContainer.children[0].querySelector('div'),
      stepMarkersContainer.children[2].querySelector('div'),
      stepMarkersContainer.children[4].querySelector('div'),
      stepMarkersContainer.children[6].querySelector('div'),
    ];
  }

  function isoToday() {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  // --- API key helpers (DEMO) ---
  function getApiKeyFromLocalStorage() {
    return (localStorage.getItem("OPENROUTER_API_KEY") || "").trim();
  }
  function setApiKeyViaPrompt() {
    const v = prompt("Plak je OpenRouter API key (begint met sk-or-v1...):", getApiKeyFromLocalStorage());
    if (v && v.trim()) {
      localStorage.setItem("OPENROUTER_API_KEY", v.trim());
      alertUser("AI sleutel lokaal opgeslagen (demo).");
    } else {
      alertUser("Geen sleutel ingesteld.");
    }
  }
  function clearApiKey() {
    localStorage.removeItem("OPENROUTER_API_KEY");
    alertUser("AI sleutel gewist.");
  }

  function setStatus(type, message) {
    const setupStatus = document.getElementById('setup-status');
    const statusMessage = document.getElementById('status-message');
    if (!setupStatus || !statusMessage) return;

    setupStatus.classList.remove('d-none');
    setupStatus.classList.remove(
      "bg-primary-subtle", "text-primary", "border-primary-subtle",
      "bg-danger-subtle", "text-danger", "border-danger-subtle",
      "bg-success-subtle", "text-success", "border-success-subtle"
    );

    if (type === "success") setupStatus.classList.add("bg-success-subtle", "text-success", "border-success-subtle");
    else if (type === "danger") setupStatus.classList.add("bg-danger-subtle", "text-danger", "border-danger-subtle");
    else setupStatus.classList.add("bg-primary-subtle", "text-primary", "border-primary-subtle");

    statusMessage.textContent = message;
  }

  async function readInputAsText() {
    const textArea = document.getElementById("text-input");
    const fileInput = document.getElementById("file-input");
    const file = fileInput?.files?.[0];

    if (!file) return (textArea?.value || "").trim();

    const ext = (file.name.split(".").pop() || "").toLowerCase();

    if (ext === "txt" || ext === "csv") return (await file.text()).trim();

    if (ext === "xlsx" || ext === "xls") {
      const buf = await file.arrayBuffer();
      const wb = XLSX.read(buf, { type: "array" });
      const sheetName = wb.SheetNames[0];
      const ws = wb.Sheets[sheetName];
      const rows = XLSX.utils.sheet_to_json(ws, { header: 1, raw: false });
      return rows.map(r => r.filter(Boolean).join(" | ")).join("\n").trim();
    }

    if (ext === "pdf") {
      const buf = await file.arrayBuffer();

      if (window.pdfjsLib?.GlobalWorkerOptions) {
        window.pdfjsLib.GlobalWorkerOptions.workerSrc =
          "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.worker.min.js";
      }

      const pdf = await window.pdfjsLib.getDocument({ data: buf }).promise;
      let text = "";
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        const pageText = content.items.map(it => it.str).join(" ");
        text += pageText + "\n";
      }
      return text.trim();
    }

    throw new Error("Onbekend bestandstype. Gebruik PDF, Excel, CSV of TXT.");
  }

  function safeParseJsonArray(s) {
    // 1) direct parse
    try {
      const v = JSON.parse(s);
      if (Array.isArray(v)) return v;
    } catch (e) {}

    // 2) try extracting [...] and parse
    const start = s.indexOf("[");
    const end = s.lastIndexOf("]");
    if (start !== -1 && end !== -1 && end > start) {
      try {
        const slice = s.slice(start, end + 1);
        const v2 = JSON.parse(slice);
        if (Array.isArray(v2)) return v2;
      } catch (e) {}
    }

    throw new Error("AI output is geen geldige JSON array.");
  }

  // ===== (Option 1) no extra confirmation step =====
  function updateConfirmationText() {
    updateProgress();
  }

  // ===== AI extraction (OpenRouter) =====
  async function handleTextUpload() {
    const textInput = await readInputAsText();
    const processBtn = document.getElementById('ai-process-btn');

    if (!textInput) {
      alertUser("Voer eerst tekst in of upload een bestand.");
      return;
    }

    const leerlingLeerjaar = document.getElementById("niveau-select")?.value;
    const leerlingStroom = document.getElementById("stroom-select")?.value;
    const endISO = document.getElementById("start-date-input")?.value; // einddatum planning
    const startISO = isoToday(); // vandaag

    if (!leerlingLeerjaar || !leerlingStroom) {
      alertUser("Selecteer eerst leerjaar en onderwijsstroom.");
      return;
    }
    if (!endISO) {
      alertUser("Selecteer een einddatum (tot wanneer je planning loopt).");
      return;
    }

    let apiKey = getApiKeyFromLocalStorage();
    if (!apiKey) {
      setApiKeyViaPrompt();
      apiKey = getApiKeyFromLocalStorage();
    }
    if (!apiKey) {
      alertUser("Geen OpenRouter API key ingesteld.");
      return;
    }

    // loading state
    const originalBtnText = processBtn?.innerHTML || "";
    if (processBtn) {
      processBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Analyseren...';
      processBtn.disabled = true;
    }

    const restoreButton = () => {
      if (!processBtn) return;
      processBtn.innerHTML = originalBtnText;
      processBtn.disabled = false;
    };

    try {
      setStatus("primary", "AI analyse bezig...");

      const prompt = `
You are a study-task extraction engine.

Student profile:
- grade_year: ${leerlingLeerjaar}
- school_track: ${leerlingStroom}

Allowed planning window:
- start_date: ${startISO}
- end_date: ${endISO}

Analyze the following text and extract study tasks.
Return ONLY a valid JSON array of objects. Do not use Markdown formatting (no \`\`\`).

Each object must have these keys:
- "Vaknaam" (string)
- "Stof_Omschrijving" (string)
- "Type_Toets" (one of: "Kennis","Inzicht","Toepassing","Woordenschat")
- "Aanbevolen_Methode" (one of: "Samenvatten","Oefensommen","Flashcards","Mindmap")
- "Geschatte_Tijd_Min" (integer)
- "Einddatum" (YYYY-MM-DD or null if not present in the input)

Rules:
- If the input includes tasks clearly meant for a different grade/track, ignore them.
- If a task has an explicit "Einddatum" and it is outside the planning window, exclude it.
- Do NOT invent dates. Use null when not present.

Text to analyze:
"${textInput}"
      `.trim();

      const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${apiKey}`,
          "HTTP-Referer": window.location.href,
          "X-Title": "StudeerPlanner AI",
        },
        body: JSON.stringify({
          model: "google/gemini-2.0-flash-lite-001",
          messages: [{ role: "user", content: prompt }],
        }),
      });

      if (!response.ok) {
        let errorMsg = response.statusText;
        try {
          const errorData = await response.json();
          if (errorData?.error?.message) errorMsg = errorData.error.message;
        } catch (e) {}
        throw new Error(`API Error (${response.status}): ${errorMsg}`);
      }

      const result = await response.json();
      let aiText = result?.choices?.[0]?.message?.content ?? "";

      aiText = aiText.replace(/```json/g, "").replace(/```/g, "").trim();
      const parsedDataRaw = safeParseJsonArray(aiText);

      const parsedDataFiltered = parsedDataRaw.filter((item) => {
        const d = item?.Einddatum;
        if (!d) return true;
        return d >= startISO && d <= endISO;
      });

      const colorMap = ["primary", "danger", "success", "warning", "info", "secondary"];
      const groupedData = {};

      parsedDataFiltered.forEach((item) => {
        if (!item?.Vaknaam || !item?.Stof_Omschrijving) return;

        if (!groupedData[item.Vaknaam]) groupedData[item.Vaknaam] = [];

        const minutes = Number(item.Geschatte_Tijd_Min);
        groupedData[item.Vaknaam].push({
          name: item.Stof_Omschrijving,
          type: item.Type_Toets || "Kennis",
          time: Number.isFinite(minutes) ? minutes : 30,
        });
      });

      importedSubjectData = Object.keys(groupedData).map((subjectName, index) => {
        const nextColor = colorMap[index % colorMap.length];
        return {
          name: subjectName,
          color: `bg-${nextColor}`,
          shortColor: nextColor,
          tests: groupedData[subjectName],
        };
      });

      setStatus("success", `AI Analyse succesvol! ${importedSubjectData.length} vak(ken) gevonden.`);
      loadSubjects();
      updateProgress();

      document.getElementById('step-2-subjects')?.scrollIntoView({ behavior: "smooth" });

    } catch (error) {
      console.error(error);
      setStatus("danger", `Fout bij AI-analyse: ${error.message}`);
      alertUser(`Fout bij AI-analyse: ${error.message}`);
    } finally {
      restoreButton();
    }
  }

  // ===== Progress logic =====
  function updateProgress() {
    const endDateInput = document.getElementById('start-date-input');
    const step2Subjects = document.getElementById('step-2-subjects');
    const step3Intake = document.getElementById('step-3-intake');
    const generateSection = document.getElementById('generate-section');
    const step4Result = document.getElementById('step-4-result');

    if (!endDateInput || !step2Subjects || !step3Intake || !generateSection || !step4Result) return;

    const isDateSelected = endDateInput.value !== '';
    const leerlingLeerjaar = document.getElementById("niveau-select")?.value;
    const leerlingStroom = document.getElementById("stroom-select")?.value;
    const isProfileSelected = !!leerlingLeerjaar && !!leerlingStroom;

    // NOTE: fallback makes this always available as demo
    const dataIsLoaded = (importedSubjectData && importedSubjectData.length >= 0) || SUBJECT_DATA_FALLBACK.length > 0;
    const isStep2Complete = isProfileSelected && dataIsLoaded;

    if (isStep2Complete) {
      step2Subjects.classList.remove('d-none');
      const container = document.getElementById('subject-checkboxes');
      if (container && container.children.length === 0) {
        loadSubjects();
      }
    } else {
      step2Subjects.classList.add('d-none');
    }

    const isStep3Ready = isStep2Complete && isDateSelected && selectedSubjectsCount > 0;

    // reset markers (except step 1 which is static in HTML)
    stepMarkers.forEach((marker, index) => {
      if (index > 0) {
        marker.classList.remove('step-active');
        marker.classList.add('border-secondary', 'text-secondary');
      }
    });

    if (isStep2Complete && stepMarkers[1]) {
      stepMarkers[1].classList.add('step-active');
      stepMarkers[1].classList.remove('border-secondary', 'text-secondary');
    }

    if (isStep3Ready) {
      if (stepMarkers[2]) {
        stepMarkers[2].classList.add('step-active');
        stepMarkers[2].classList.remove('border-secondary', 'text-secondary');
      }
      step3Intake.classList.remove('d-none');
      generateSection.classList.remove('d-none');
    } else {
      step3Intake.classList.add('d-none');
      generateSection.classList.add('d-none');
      step4Result.classList.add('d-none');
      if (stepMarkers[3]) stepMarkers[3].classList.remove('step-active');
    }
  }

  // ===== UI helpers =====
  function updateTitle() {
    const firstName = document.getElementById('first-name')?.value.trim() || "";
    const lastName = document.getElementById('last-name')?.value.trim() || "";
    const today = new Date().toLocaleDateString('nl-NL');
    const mainHeader = document.getElementById('main-header-title');
    const mainSubtitle = document.getElementById('main-header-subtitle');

    let titleText = "StudeerPlanner AI - Bootstrap";
    if (firstName || lastName) titleText = `Studieplanning van ${firstName} ${lastName}, datum: ${today}`;
    document.title = titleText;

    if (!mainHeader || !mainSubtitle) return;

    if (firstName || lastName) {
      mainHeader.textContent = `Gepersonaliseerde studieplan van ${firstName} ${lastName}`;
      mainSubtitle.textContent = `Op datum van vandaag: ${today}`;
      mainSubtitle.classList.add('text-dark', 'fw-bold');
      mainSubtitle.classList.remove('text-secondary', 'lead');
    } else {
      mainHeader.textContent = "Jouw gepersonaliseerde studieplan";
      mainSubtitle.textContent = "Laat de AI jouw studielast verdelen in haalbare, motiverende stappen.";
      mainSubtitle.classList.add('text-secondary', 'lead');
      mainSubtitle.classList.remove('text-dark', 'fw-bold');
    }
  }

  function updateSelectedSubjectsCount() {
    selectedSubjectsCount = document.querySelectorAll('#subject-checkboxes input:checked').length;
    updateTestOverview();
    updateProgress();
  }

  function loadSubjects() {
    const checkboxContainer = document.getElementById('subject-checkboxes');
    if (!checkboxContainer) return;

    const dataToUse = (importedSubjectData && importedSubjectData.length > 0) ? importedSubjectData : SUBJECT_DATA_FALLBACK;

    checkboxContainer.innerHTML = dataToUse.map((subject, index) => `
      <div class="col-6 col-sm-4 col-md-3">
        <div class="p-2 bg-white rounded-3 border border-secondary-subtle shadow-sm">
          <div class="form-check">
            <input class="form-check-input border-secondary-subtle fs-5" type="checkbox" checked onchange="updateSelectedSubjectsCount()" id="check-${subject.shortColor}-${index}" style="margin-top: 0.3em;">
            <label class="form-check-label fw-medium text-dark" for="check-${subject.shortColor}-${index}">
              ${subject.name}
            </label>
          </div>
        </div>
      </div>
    `).join('');

    updateSelectedSubjectsCount();
  }

  function updateTestOverview() {
    const overviewContainer = document.getElementById('test-overview');
    const checkboxes = document.querySelectorAll('#subject-checkboxes input[type="checkbox"]');
    const dataToUse = (importedSubjectData && importedSubjectData.length > 0) ? importedSubjectData : SUBJECT_DATA_FALLBACK;

    if (!overviewContainer) return;

    const selectedVakken = dataToUse.filter((subject, index) => checkboxes[index] && checkboxes[index].checked);

    if (selectedVakken.length === 0) {
      overviewContainer.innerHTML = '<p class="small text-secondary mb-0">Selecteer minimaal één vak om het overzicht te zien.</p>';
      return;
    }

    overviewContainer.innerHTML = `
      <div class="row g-3">
        ${selectedVakken.map(subject => `
          <div class="col-12">
            <div class="d-flex align-items-start p-3 rounded-3 border border-secondary-subtle shadow-sm bg-white">
              <span class="badge ${subject.color} rounded-circle me-3 mt-1" style="width: 12px; height: 12px; min-width: 12px; min-height: 12px; display: inline-block;"></span>
              <div>
                <p class="fw-semibold text-dark mb-1">${subject.name}:</p>
                <ul class="list-unstyled small text-secondary mb-0 ps-3">
                  ${(subject.tests || []).map(test => `
                    <li class="position-relative" style="padding-left: 1rem;">
                      <span class="position-absolute" style="left: -0.5rem; top: 0.2rem; line-height: 1;">&bull;</span>
                      ${test.name}
                      <span class="badge bg-primary-subtle text-primary border border-primary-subtle rounded-pill ms-2 fw-medium">${test.type}</span>
                    </li>
                  `).join('')}
                </ul>
              </div>
            </div>
          </div>
        `).join('')}
      </div>
    `;
  }

  function selectStyle(id) {
    const selectedButton = document.querySelector(`label[for="${id}"]`);
    const buttonGroup = selectedButton?.closest('.btn-group');
    if (!buttonGroup) return;

    buttonGroup.querySelectorAll('.btn-check').forEach(radio => {
      if (radio.id !== id) radio.checked = false;
    });
    const radio = document.getElementById(id);
    if (radio) radio.checked = true;
  }

  function generatePlan() {
    const endDate = document.getElementById('start-date-input')?.value;
    const resultSection = document.getElementById('step-4-result');
    const generateButton = document.querySelector('#generate-section button');
    const step4Marker = stepMarkers[3];

    if (!endDate || selectedSubjectsCount === 0) {
      alertUser('Zorg ervoor dat je een einddatum hebt geselecteerd en minimaal één vak hebt aangevinkt.');
      return;
    }

    if (!generateButton || !resultSection) return;

    generateButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Plan Genereren...';
    generateButton.disabled = true;

    setTimeout(() => {
      resultSection.classList.remove('d-none');

      if (step4Marker) {
        step4Marker.classList.add('step-active');
        step4Marker.classList.remove('border-secondary', 'text-secondary');
        step4Marker.style.borderColor = 'var(--bs-success)';
        step4Marker.style.backgroundColor = 'var(--bs-success)';
      }

      generateButton.innerHTML = '<svg class="me-3" width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg> Genereer Mijn Persoonlijke Plan';
      generateButton.disabled = false;

      resultSection.scrollIntoView({ behavior: 'smooth' });
    }, 1200);
  }

  function alertUser(message, variant = "danger") {
  // Create toast container once
  let container = document.getElementById("toast-container");
  if (!container) {
    container = document.createElement("div");
    container.id = "toast-container";
    container.className = "toast-container position-fixed top-0 end-0 p-3";
    container.style.zIndex = "1080";
    document.body.appendChild(container);
  }

  const toastEl = document.createElement("div");
  toastEl.className = `toast align-items-center text-bg-${variant} border-0`;
  toastEl.setAttribute("role", "alert");
  toastEl.setAttribute("aria-live", "assertive");
  toastEl.setAttribute("aria-atomic", "true");

  toastEl.innerHTML = `
    <div class="d-flex">
      <div class="toast-body">${String(message)}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  `;

  container.appendChild(toastEl);

  const toast = new bootstrap.Toast(toastEl, { delay: 2800 });
  toast.show();

  toastEl.addEventListener("hidden.bs.toast", () => toastEl.remove());
}

  document.addEventListener('DOMContentLoaded', () => {
    const firstNameInput = document.getElementById('first-name');
    const lastNameInput = document.getElementById('last-name');
    const endDateInput = document.getElementById('start-date-input');

    // keep your existing inline handlers; these are just extra safety if you later remove them
    if (firstNameInput) firstNameInput.addEventListener('input', updateProgress);
    if (lastNameInput) lastNameInput.addEventListener('input', updateProgress);
    if (endDateInput) endDateInput.addEventListener('change', updateProgress);

    updateTitle();
    updateProgress();
  });

  // Expose functions for inline HTML handlers
  Object.assign(window, {
    handleTextUpload,
    updateTitle,
    updateConfirmationText,
    updateProgress,
    generatePlan,
    selectStyle,
    updateSelectedSubjectsCount,
    setApiKeyViaPrompt,
    clearApiKey,
  });
</script>
</body>
</html>
